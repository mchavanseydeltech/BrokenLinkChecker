name: Bunnings Check

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM UTC
  workflow_dispatch:      # Manual trigger

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Chrome and Python
      run: |
        sudo apt update
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt update
        sudo apt install -y google-chrome-stable python3-pip
        
        # Install ChromeDriver (required for Selenium)
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d'.' -f1)
        wget -q "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION"
        CHROMEDRIVER_VERSION=$(cat LATEST_RELEASE_$CHROME_VERSION)
        wget -q "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
        unzip chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        # Install Python packages
        pip3 install selenium==4.15.0 undetected-chromedriver==3.5.4 requests==2.31.0
        
    - name: Create and run script
      run: |
        cat > check.py << 'EOF'
import requests, time, csv, os
from datetime import datetime
from selenium import webdriver
from selenium.webdriver.common.by import By

# ========== HARDCODED SECRETS ==========
SHOP_DOMAIN = "cassien24.myshopify.com"  # â† CHANGE
ACCESS_TOKEN = "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"         # â† CHANGE
# =======================================

print("Starting Bunnings Check...")
options = webdriver.ChromeOptions()
options.add_argument('--headless')
options.add_argument('--no-sandbox')
driver = webdriver.Chrome(options=options)

try:
    # Fetch products
    headers = {"X-Shopify-Access-Token": ACCESS_TOKEN}
    products = []
    url = f"https://{SHOP_DOMAIN}/admin/api/2024-01/products.json?limit=250"
    
    response = requests.get(url, headers=headers)
    for product in response.json().get('products', []):
        for metafield in product.get('metafields', []):
            if metafield.get('namespace') == 'custom' and metafield.get('key') == 'au_link':
                bunnings_url = metafield.get('value')
                if bunnings_url:
                    products.append({
                        'id': product['id'],
                        'title': product['title'],
                        'url': bunnings_url
                    })
    
    print(f"Found {len(products)} products")
    
    # Check each URL
    results = []
    for product in products:
        print(f"Checking: {product['title'][:30]}...")
        try:
            driver.get(product['url'])
            time.sleep(5)
            page_text = driver.page_source.lower()
            
            if 'add to cart' in page_text or 'add to trolley' in page_text:
                status = 'working'
                working = True
            elif 'out of stock' in page_text:
                status = 'out_of_stock'
                working = False
            else:
                status = 'not_working'
                working = False
        except:
            status = 'error'
            working = False
        
        results.append({
            'product': product['title'],
            'url': product['url'],
            'status': status,
            'working': working
        })
        time.sleep(1)
    
    # Save results
    timestamp = datetime.now().strftime('%Y%m%d_%H%M')
    filename = f'results_{timestamp}.csv'
    with open(filename, 'w') as f:
        writer = csv.writer(f)
        writer.writerow(['Product', 'URL', 'Status', 'Working'])
        for r in results:
            writer.writerow([r['product'], r['url'], r['status'], 'Yes' if r['working'] else 'No'])
    
    print(f"Saved to {filename}")
    
finally:
    driver.quit()
EOF

        # Replace placeholders with YOUR actual values
        sed -i "s/YOUR-ACTUAL-STORE/cassien24.myshopify.com/g" bunnings_checker.py
        sed -i "s/shpat_YOUR_ACTUAL_TOKEN/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/g" bunnings_checker.py
        
        python3 check.py
        
    - name: Upload results
      uses: actions/upload-artifact@v4  # CHANGED FROM v3 to v4
      with:
        name: results
        path: results_*.csv
        
    - name: Display completion message
      run: |
        echo "=========================================="
        echo "ðŸ Bunnings Check Completed!"
        echo "=========================================="
        echo ""
        echo "To download results:"
        echo "1. Go to this workflow run"
        echo "2. Scroll to 'Artifacts' section"
        echo "3. Download 'results'"
        echo ""
        echo "Files available for download:"
        ls -la results_*.csv 2>/dev/null || echo "No CSV files found"
        echo "=========================================="
