name: Bunnings Check

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM UTC
  workflow_dispatch:      # Manual trigger

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Chrome and Python
      run: |
        sudo apt update
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt update
        sudo apt install -y google-chrome-stable python3-pip
        
        # Install ChromeDriver (required for Selenium)
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d'.' -f1)
        wget -q "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION"
        CHROMEDRIVER_VERSION=$(cat LATEST_RELEASE_$CHROME_VERSION)
        wget -q "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
        unzip chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        # Install Python packages
        pip3 install selenium==4.15.0 undetected-chromedriver==3.5.4 requests==2.31.0
        
    - name: Configure script with hardcoded secrets
      run: |
        echo "ðŸ“ Configuring bunnings_checker.py with your secrets..."
        
        # Make sure your script exists
        if [ ! -f "bunnings_checker.py" ]; then
          echo "âŒ ERROR: bunnings_checker.py not found in repository!"
          echo "Please make sure your script is committed to the repository."
          exit 1
        fi
        
        # Check current configuration in your script
        echo "Current configuration in your script:"
        grep -A2 -B2 "SHOPIFY" bunnings_checker.py || echo "No SHOPIFY config found"
        
        # IMPORTANT: Update your bunnings_checker.py file FIRST with your actual secrets
        # The script should already have hardcoded values like:
        # SHOPIFY_STORE_DOMAIN = "cassien24.myshopify.com"
        # SHOPIFY_ACCESS_TOKEN = "shpat_your_actual_token"
        
        echo ""
        echo "âœ… Assuming your bunnings_checker.py already has correct hardcoded values"
        echo "   If not, update the file in your repository before running this workflow"
        
    - name: Run Bunnings Checker
      run: |
        echo "ðŸš€ Running your bunnings_checker.py script..."
        python3 bunnings_checker.py
        
    - name: Upload results
      uses: actions/upload-artifact@v3
      with:
        name: bunnings-check-results
        path: |
          bunnings_results_*.csv
          direct_test_results_*.csv
          shopify_test_results_*.csv
          results_*.csv
        retention-days: 30
        
    - name: Display completion message
      if: always()
      run: |
        echo "=========================================="
        echo "ðŸ Workflow Completed!"
        echo "=========================================="
        echo ""
        echo "Generated files:"
        ls -la *.csv 2>/dev/null || echo "No CSV files generated"
        echo ""
        echo "To download results:"
        echo "1. Go to this workflow run"
        echo "2. Scroll to 'Artifacts' section"
        echo "3. Download 'bunnings-check-results'"
        echo "=========================================="
