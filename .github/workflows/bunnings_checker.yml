name: Bunnings Checker

on:
  workflow_dispatch:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'

permissions:
  contents: write

jobs:
  run-bunnings-checker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Chrome dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip xvfb
          # Install Chrome
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          # Get Chrome version for matching ChromeDriver
          CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d'.' -f1)
          # Download ChromeDriver
          wget -q "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROME_VERSION}.0.0.0/linux64/chromedriver-linux64.zip"
          unzip -q chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          rm -rf chromedriver-linux64.zip chromedriver-linux64/

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install undetected-chromedriver requests selenium

      - name: Run Bunnings Checker Script
        timeout-minutes: 30
        env:
          SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_TOKEN: ${{ secrets.SHOPIFY_TOKEN }}
          SHOPIFY_API_VERSION: '2024-10'
        run: |
          # Start virtual display for headless Chrome
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          export DISPLAY=:99
          
          echo "Starting Bunnings Checker..."
          echo "Store: $SHOPIFY_STORE"
          
          # Create a modified version of the script with environment variables
          python << 'EOF'
          import os
          import sys
          
          # Read the original script
          with open('bunnings_checker.py', 'r') as f:
              content = f.read()
          
          # Replace hardcoded credentials with environment variables
          new_content = content.replace(
              'SHOPIFY_STORE = "seydeltest"',
              f'SHOPIFY_STORE = "{os.environ.get("SHOPIFY_STORE", "seydeltest")}"'
          )
          new_content = new_content.replace(
              'SHOPIFY_TOKEN = "xxxxxxxxx"',
              f'SHOPIFY_TOKEN = "{os.environ.get("SHOPIFY_TOKEN", "xxxxxxxxx")}"'
          )
          new_content = new_content.replace(
              'SHOPIFY_API_VERSION = "2024-10"',
              f'SHOPIFY_API_VERSION = "{os.environ.get("SHOPIFY_API_VERSION", "2024-10")}"'
          )
          
          # Write the modified script
          with open('bunnings_checker_modified.py', 'w') as f:
              f.write(new_content)
          
          print("Modified script created")
          EOF
          
          # Run the modified script
          python bunnings_checker_modified.py
          
          echo "Script execution completed"

      - name: List generated files
        run: |
          echo "Generated files:"
          ls -la *.csv 2>/dev/null || echo "No CSV files found"
          echo ""
          echo "File sizes:"
          find . -name "*.csv" -exec ls -lh {} \; 2>/dev/null || true

      - name: Upload CSV results
        uses: actions/upload-artifact@v4
        with:
          name: bunnings-results-${{ github.run_number }}
          path: |
            bunnings_*.csv
            bunnings_url_check_*.csv
          retention-days: 7

      - name: Upload results to repository
        if: success() && github.ref == 'refs/heads/main'
        run: |
          # Create results directory if it doesn't exist
          mkdir -p results
          
          # Move CSV files to results directory with timestamp
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          for file in bunnings_*.csv bunnings_url_check_*.csv; do
            if [ -f "$file" ]; then
              mv "$file" "results/${TIMESTAMP}_${file}"
            fi
          done
          
          # Only commit if there are files
          if [ "$(ls -A results 2>/dev/null)" ]; then
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "GitHub Actions"
            git add results/
            git commit -m "Add Bunnings checker results - Run ${{ github.run_number }}"
            git push origin main
          else
            echo "No CSV files to commit"
          fi

      - name: Create summary report
        if: always()
        run: |
          echo "## Bunnings Checker Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find and count CSV files
          CSV_FILES=$(find . -name "*.csv" -type f)
          if [ -n "$CSV_FILES" ]; then
            echo "✅ **CSV files generated:** $(echo "$CSV_FILES" | wc -l)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Generated files:**" >> $GITHUB_STEP_SUMMARY
            for file in $CSV_FILES; do
              SIZE=$(du -h "$file" | cut -f1)
              LINES=$(wc -l < "$file" 2>/dev/null || echo "0")
              FILENAME=$(basename "$file")
              echo "- \`$FILENAME\` ($SIZE, $((LINES-1)) data rows)" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "❌ **No CSV files generated**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the script output for errors." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Run: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
