name: Bunnings URL Checker

on:
  # Run on push to main branch
  push:
    branches: [ "main" ]
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      urls_file:
        description: 'URLs file path'
        default: 'bunnings_urls.txt'
        required: false
      run_mode:
        description: 'Run mode'
        type: choice
        options: ['full', 'quick']
        default: 'full'

  # Schedule daily at 8 AM UTC
  schedule:
    - cron: '0 8 * * *'

jobs:
  check-urls:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Prevent infinite runs
    
    steps:
    # 1. Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # 2. Setup Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    # 3. Install system dependencies
    - name: Install system packages
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          unzip \
          libnss3 \
          libatk-bridge2.0-0 \
          libdrm2 \
          libxkbcommon0 \
          libgbm1 \
          libasound2
        
        echo "âœ… System packages installed"
    
    # 4. Install Chrome
    - name: Install Google Chrome
      run: |
        # Install Chrome from official repo
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Verify installation
        google-chrome --version
        echo "âœ… Chrome installed"
    
    # 5. Install ChromeDriver
    - name: Install ChromeDriver
      run: |
        # Get Chrome version
        CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+\.\d+')
        echo "Chrome version: $CHROME_VERSION"
        
        # Download matching ChromeDriver
        CHROMEDRIVER_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
        echo "Using ChromeDriver version: $CHROMEDRIVER_VERSION"
        
        # Download from official source
        wget -q "https://storage.googleapis.com/chrome-for-testing-public/$CHROMEDRIVER_VERSION.0.0/linux64/chromedriver-linux64.zip" -O chromedriver.zip
        
        # Extract and install
        unzip -o chromedriver.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        # Verify
        chromedriver --version
        echo "âœ… ChromeDriver installed"
    
    # 6. Install Python dependencies
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
        # Also install additional useful packages
        pip install requests beautifulsoup4 lxml
        
        echo "âœ… Python dependencies installed"
    
    # 7. Create URLs file if it doesn't exist
    - name: Setup URLs file
      run: |
        # Use input file or default
        URLS_FILE="${{ inputs.urls_file || 'bunnings_urls.txt' }}"
        
        if [ ! -f "$URLS_FILE" ]; then
          echo "ðŸ“ Creating sample URLs file..."
          python -c "
sample_urls = '''https://www.bunnings.com.au/orion-grid-connect-smart-rechargeable-2k-security-camera-4-pack_p0503618
https://www.bunnings.com.au/orion-4k-wired-outdoor-security-camera_p0252107
https://www.bunnings.com.au/orion-grid-connect-smart-doorbell-camera_p0252108
'''
with open('$URLS_FILE', 'w') as f:
    f.write(sample_urls)
          "
          echo "âœ… Created sample file: $URLS_FILE"
        else
          echo "âœ… Using existing file: $URLS_FILE"
          echo "ðŸ“„ File contents preview:"
          head -5 "$URLS_FILE"
        fi
    
    # 8. Run the checker
    - name: Run Bunnings URL Checker
      id: run-checker
      env:
        GITHUB_ACTIONS: 'true'
        PYTHONUNBUFFERED: '1'
      run: |
        echo "ðŸš€ Starting Bunnings URL Checker..."
        echo "======================================"
        
        # Run the script
        python bunnings_checker_github.py
        
        echo "======================================"
        echo "âœ… Checker completed"
        
        # List generated files
        echo "ðŸ“ Generated files:"
        ls -la checker_results/ 2>/dev/null || echo "No results directory"
    
    # 9. Upload results as artifact
    - name: Upload results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bunnings-results
        path: |
          checker_results/
          bunnings_urls.txt
        retention-days: 7
    
    # 10. Upload summary to job summary
    - name: Create job summary
      if: always()
      run: |
        echo "# Bunnings URL Checker Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "checker_results" ]; then
          # Find latest summary file
          LATEST_SUMMARY=$(ls -t checker_results/*summary*.txt 2>/dev/null | head -1)
          
          if [ -f "$LATEST_SUMMARY" ]; then
            cat "$LATEST_SUMMARY" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No summary file found" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ No results directory found" >> $GITHUB_STEP_SUMMARY
        fi
