name: Bunnings URL Checker
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      urls_file:
        description: 'URLs file to use'
        default: 'bunnings_urls.txt'
        required: false
      headless:
        description: 'Run in headless mode'
        type: boolean
        default: true

jobs:
  check-bunnings-urls:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    # 1. Checkout repository
    - name: Checkout code
      uses: actions/checkout@v4
    
    # 2. Setup Python
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. Install Chrome browser
    - name: Install Google Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        echo "Chrome version installed: $(google-chrome --version)"
    
    # 4. Install ChromeDriver (MUST match Chrome version)
    - name: Install ChromeDriver
      run: |
        # Get installed Chrome version
        CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+\.\d+')
        echo "Chrome version: $CHROME_VERSION"
        
        # Extract major version
        CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
        echo "Major version: $CHROME_MAJOR_VERSION"
        
        # Download matching ChromeDriver
        wget -q "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_MAJOR_VERSION" -O chromedriver_version.txt
        CHROMEDRIVER_VERSION=$(cat chromedriver_version.txt)
        echo "ChromeDriver version: $CHROMEDRIVER_VERSION"
        
        # Download and install
        wget -q "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
        unzip -o chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        # Verify installation
        echo "ChromeDriver installed: $(chromedriver --version)"
    
    # 5. Install Python dependencies
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
        # Additional packages for debugging
        pip install requests
        
        # List installed packages
        pip list | grep -E "(selenium|undetected-chromedriver|requests)"
    
    # 6. Create bunnings_urls.txt if it doesn't exist
    - name: Setup URLs file
      run: |
        if [ ! -f "bunnings_urls.txt" ]; then
          echo "ðŸ“ Creating sample bunnings_urls.txt file..."
          cat > bunnings_urls.txt << 'EOF'
# Sample Bunnings URLs - Add your URLs below
https://www.bunnings.com.au/orion-grid-connect-smart-rechargeable-2k-security-camera-4-pack_p0503618
https://www.bunnings.com.au/orion-4k-wired-outdoor-security-camera_p0252107
https://www.bunnings.com.au/search/products?q=security+camera
EOF
          echo "âœ… Created sample bunnings_urls.txt"
        fi
        
        echo "ðŸ“„ URLs file preview:"
        head -10 bunnings_urls.txt
        echo ""
        echo "Total lines: $(wc -l < bunnings_urls.txt)"
    
    # 7. Debug: Show directory structure
    - name: Debug - Show files
      run: |
        echo "ðŸ“ Current directory structure:"
        ls -la
        echo ""
        echo "ðŸ“ .github/workflows directory:"
        ls -la .github/workflows/
        echo ""
        echo "ðŸ“„ Python script check:"
        if [ -f "bunnings_checker.py" ]; then
          echo "âœ… bunnings_checker.py exists"
          head -5 bunnings_checker.py
        else
          echo "âŒ bunnings_checker.py NOT FOUND"
        fi
    
    # 8. Run the Bunnings checker
    - name: Run Bunnings URL Checker
      id: run-checker
      env:
        GITHUB_ACTIONS: 'true'
        PYTHONUNBUFFERED: '1'
      run: |
        echo "ðŸš€ Starting Bunnings URL Checker..."
        echo "========================================"
        
        # Run the Python script
        python bunnings_checker.py
        
        echo "========================================"
        echo "âœ… Checker completed"
        
        # List any result files
        echo "ðŸ“Š Generated files:"
        ls -la *.csv 2>/dev/null || echo "No CSV files found"
        ls -la results_* 2>/dev/null || echo "No result files found"
    
    # 9. Upload results as artifacts
    - name: Upload results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bunnings-results
        path: |
          results_*.csv
          bunnings_urls.txt
        retention-days: 7
    
    # 10. Create summary
    - name: Create summary
      if: always()
      run: |
        echo "## ðŸ“Š Bunnings URL Checker Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow completed at:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check for results
        RESULT_FILES=$(ls results_*.csv 2>/dev/null || true)
        
        if [ -n "$RESULT_FILES" ]; then
          LATEST_RESULT=$(ls -t results_*.csv | head -1)
          echo "**Latest results file:** \`$LATEST_RESULT\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show summary from CSV
          echo "**Results summary:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "URLs tested: $(tail -n +2 $LATEST_RESULT | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "Working: $(grep -i 'WORKING' $LATEST_RESULT | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "Not working: $(grep -i 'NOT_WORKING' $LATEST_RESULT | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "Errors: $(grep -i 'ERROR' $LATEST_RESULT | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ No results files found" >> $GITHUB_STEP_SUMMARY
        fi
