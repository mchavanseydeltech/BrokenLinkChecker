name: Bunnings Availability Checker

on:
  schedule:
    # Run daily at 6 AM UTC (4 PM Sydney time)
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual triggers
  push:
    branches: [ main, master ]

jobs:
  check-bunnings:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Chrome and dependencies
      run: |
        sudo apt-get update
        
        # Install Chrome from Google's repository (more reliable)
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Install ChromeDriver that matches Chrome version
        CHROME_VERSION=$(google-chrome-stable --version | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+')
        CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
        echo "Installed Chrome version: $CHROME_VERSION"
        echo "Chrome major version: $CHROME_MAJOR_VERSION"
        
        # Download matching ChromeDriver
        CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_MAJOR_VERSION")
        wget -q "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
        unzip chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        # Verify installations
        echo "=== VERIFICATION ==="
        echo "Google Chrome:"
        google-chrome-stable --version
        echo "ChromeDriver:"
        chromedriver --version
        
        # Install additional dependencies
        sudo apt-get install -y xvfb
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        
        echo "=== INSTALLING SHOPIFY API ==="
        # Try the most common Shopify packages
        # The official package is now 'shopify-python-api'
        echo "1. Trying: shopify-python-api"
        pip install shopify-python-api 2>&1 | tail -20
        
        echo "2. Testing import..."
        python -c "
import sys
print('Python version:', sys.version)

# Test import
try:
    import shopify
    print('âœ… SUCCESS: Imported shopify')
    print('   Module location:', shopify.__file__)
    
    # Test basic functionality
    try:
        shopify.Session.setup(api_key='test', password='test')
        print('âœ… SUCCESS: Shopify session setup works')
    except Exception as e:
        print('âš ï¸  Note: Session setup failed (expected without credentials):', str(e)[:100])
    
except ImportError as e:
    print('âŒ shopify-python-api failed, trying shopifyapi...')
    
    # Try alternative package
    import subprocess
    import sys
    subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'shopifyapi'])
    
    # Test again
    try:
        import shopify
        print('âœ… SUCCESS: Imported shopify (from shopifyapi package)')
        print('   Module location:', shopify.__file__)
    except ImportError as e2:
        print('âŒ ALL SHOPIFY PACKAGES FAILED')
        print('   Error 1:', str(e))
        print('   Error 2:', str(e2))
        print('\\nPlease check available packages:')
        print('   pip search shopify')
        sys.exit(1)
        "
        
        echo "=== INSTALLING OTHER DEPENDENCIES ==="
        pip install selenium undetected-chromedriver
        
        echo "=== FINAL PACKAGE LIST ==="
        echo "Shopify-related packages:"
        pip list | grep -i shopify || echo "  (none found)"
        echo "Selenium packages:"
        pip list | grep -i selenium || echo "  (none found)"
    
    - name: Debug - Check script exists
      run: |
        echo "=== CHECKING FILES ==="
        ls -la *.py
        echo ""
        echo "Script exists:" $(if [ -f "bunnings_checker.py" ]; then echo "âœ…"; else echo "âŒ"; fi)
    
    - name: Run Bunnings Checker
      timeout-minutes: 20
      run: |
        echo "ðŸš€ STARTING BUNNINGS AVAILABILITY CHECKER"
        echo "=========================================="
        echo "Timestamp: $(date)"
        echo "Python version: $(python --version)"
        echo ""
        
        # Create a test to verify everything works
        echo "=== PRE-FLIGHT CHECK ==="
        python -c "
import sys
print('1. Testing imports...')
try:
    import shopify
    print('   âœ… Shopify API')
except Exception as e:
    print(f'   âŒ Shopify API: {e}')
    sys.exit(1)

try:
    from selenium import webdriver
    print('   âœ… Selenium')
except Exception as e:
    print(f'   âŒ Selenium: {e}')

try:
    import undetected_chromedriver as uc
    print('   âœ… Undetected ChromeDriver')
except Exception as e:
    print(f'   âš ï¸  Undetected ChromeDriver: {e}')

print('\\n2. Testing browser...')
try:
    from selenium.webdriver.chrome.options import Options
    options = Options()
    options.add_argument('--headless')
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    
    # Use ChromeDriver we installed
    from selenium.webdriver.chrome.service import Service
    service = Service('/usr/local/bin/chromedriver')
    
    driver = webdriver.Chrome(service=service, options=options)
    driver.get('https://www.google.com')
    print(f'   âœ… Browser test passed (Title: {driver.title[:30]}...)')
    driver.quit()
except Exception as e:
    print(f'   âš ï¸  Browser test warning: {e}')
    print('   Will continue anyway...')

print('\\nâœ… All checks passed!')
        "
        
        echo ""
        echo "=== RUNNING MAIN CHECKER ==="
        
        # Run with Xvfb for headless display if available
        if command -v xvfb-run > /dev/null; then
          echo "Using xvfb-run for headless display..."
          xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" python bunnings_checker.py --quick
        else
          echo "Running without xvfb..."
          python bunnings_checker.py --quick
        fi
        
        echo ""
        echo "=========================================="
        echo "âœ… CHECKER EXECUTION COMPLETED"
    
    - name: Upload results as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bunnings-check-results
        path: |
          bunnings_check_*.csv
          bunnings_check_*.json
          requirements.txt
        retention-days: 7
    
    - name: Show summary
      if: always()
      run: |
        echo "=== EXECUTION SUMMARY ==="
        echo "Generated files:"
        find . -name "bunnings_check_*" -type f 2>/dev/null | while read file; do
          echo "  ðŸ“„ $(basename "$file") ($(du -h "$file" | cut -f1))"
        done || echo "  No result files found"
        
        echo ""
        echo "All files in directory:"
        ls -la

  # Optional: Add a notification job
  notify:
    runs-on: ubuntu-latest
    needs: check-bunnings
    if: always()
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: bunnings-check-results
        path: ./results
    
    - name: Show notification
      run: |
        echo "Workflow completed!"
        echo "Status: ${{ needs.check-bunnings.result }}"
        
        if [ -d "./results" ]; then
          echo "Results downloaded to ./results/"
          ls -la ./results/
        fi
