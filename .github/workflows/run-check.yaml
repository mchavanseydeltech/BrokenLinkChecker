name: Bunnings Availability Checker

on:
  schedule:
    # Run daily at 6 AM UTC (4 PM Sydney time, 6 AM UTC)
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual triggers
  push:
    branches: [ main, master ]

jobs:
  check-bunnings:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Chrome and Chromedriver
      run: |
        # Install Google Chrome
        sudo apt-get update
        sudo apt-get install -y wget gnupg unzip
        
        # Download and install Google Chrome
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Get Chrome version and download matching ChromeDriver
        CHROME_VERSION=$(google-chrome-stable --version | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)
        CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
        echo "Chrome version: $CHROME_VERSION"
        echo "Chrome major version: $CHROME_MAJOR_VERSION"
        
        # Download ChromeDriver
        CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_MAJOR_VERSION")
        wget -q "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
        unzip chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        # Verify installations
        echo "Google Chrome version:"
        google-chrome-stable --version
        echo "ChromeDriver version:"
        chromedriver --version
        
        # Install additional dependencies
        sudo apt-get install -y xvfb
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install shopify selenium undetected-chromedriver
        
        # Verify installations
        echo "Installed packages:"
        pip list | grep -E "(shopify|selenium|undetected)"
    
    - name: Create requirements.txt (optional)
      run: |
        echo "shopify>=13.0.0" > requirements.txt
        echo "selenium>=4.15.0" >> requirements.txt
        echo "undetected-chromedriver>=3.5.4" >> requirements.txt
    
    - name: Test browser setup
      run: |
        # Simple test to verify Chrome works
        python -c "
import os
print('Python version:', os.sys.version)
print('Testing browser...')

from selenium import webdriver
from selenium.webdriver.chrome.options import Options

options = Options()
options.add_argument('--headless')
options.add_argument('--no-sandbox')
options.add_argument('--disable-dev-shm-usage')

try:
    driver = webdriver.Chrome(options=options)
    driver.get('https://www.google.com')
    print('‚úÖ Browser test successful')
    print('Page title:', driver.title)
    driver.quit()
except Exception as e:
    print('‚ùå Browser test failed:', e)
        "
    
    - name: Run Bunnings Checker
      timeout-minutes: 30
      run: |
        echo "üöÄ Starting Bunnings Availability Checker..."
        echo "==========================================="
        
        # Run with Xvfb for headless display if needed
        if command -v xvfb-run &> /dev/null; then
          echo "Using xvfb-run for headless display..."
          xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" python bunnings_checker.py --quick
        else
          echo "Running without xvfb..."
          python bunnings_checker.py --quick
        fi
        
        echo "==========================================="
        echo "‚úÖ Checker completed"
    
    - name: List generated files
      if: always()
      run: |
        echo "üìÅ Generated files:"
        ls -la *.csv *.json 2>/dev/null || echo "No CSV/JSON files found"
        echo ""
        echo "üìÅ All files:"
        ls -la
    
    - name: Upload results as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bunnings-check-results
        path: |
          bunnings_check_*.csv
          bunnings_check_*.json
        retention-days: 7
    
    - name: Send notification on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '‚ùå Bunnings Checker Failed',
            body: `The Bunnings Availability Checker workflow failed. Check the Actions tab for details.\n\nRun ID: ${context.runId}\nRepository: ${context.repo.owner}/${context.repo.repo}`
          })
